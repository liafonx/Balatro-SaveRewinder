[manifest]
version = "1.0"
dump_lua = true
priority = 5

# Fast Save Loader mod for Balatro.
# Folder layout:
# FastSaveLoaderMod/
# 		lovely.toml
# 		Init.lua
# 		SaveManager.lua
# 		Keybinds.lua
# 	└─ UI/
#    ├─ BackupsUI.lua
#    └─ ButtonCallbacks.lua

[[patches]]
[patches.copy]
target = "globals.lua"
position = "append"
sources = [ "Init.lua" ]

[[patches]]
[patches.copy]
target = "main.lua"
position = "append"
sources = [ "Keybinds.lua" ]

[[patches]]
[patches.copy]
target = "functions/UI_definitions.lua"
position = "append"
sources = [ "UI/BackupsUI.lua" ]

[[patches]]
[patches.copy]
target = "functions/button_callbacks.lua"
position = "append"
sources = [ "UI/ButtonCallbacks.lua" ]

[[patches]]
[patches.regex]
target = "functions/button_callbacks.lua"
pattern = "func = function\\(\\)\\n      delay\\(0.3\\)"
position = "at"
payload = """func = function()
      if not G.screenwipe or not G.screenwipe.children or not G.screenwipe.children.particles then return true end
      delay(0.3)"""
match_indent = true

[[patches]]
[patches.regex]
target = "functions/button_callbacks.lua"
pattern = "func = function\\(\\)\\n      if G.screenwipecard then"
position = "at"
payload = """func = function()
      if not G.screenwipe then return true end
      if G.screenwipecard then"""
match_indent = true

[[patches]]
[patches.regex]
target = "functions/button_callbacks.lua"
pattern = "func = function\\(\\)\\n      G.screenwipe.children.particles:remove\\(\\)"
position = "at"
payload = """func = function()
      if not G.screenwipe or not G.screenwipe.children or not G.screenwipe.children.particles then return true end
      G.screenwipe.children.particles:remove()"""
match_indent = true

[[patches]]
[patches.module]
name = "LOADER"
source = "SaveManager.lua"
before = "engine/save_manager.lua"
load_now = true

[[patches]]
[patches.pattern]
target = "engine/save_manager.lua"
pattern = "compress_and_save(prefix_profile..'save.jkr', request.save_table)"
position = "after"
match_indent = true
overwrite = false
payload = "LOADER.execute_save_manager(request)"

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = "function Card:open()"
position = "after"
match_indent = true
payload = "if LOADER then LOADER.skipping_pack_open = true end"

[[patches]]
[patches.pattern]
target = "game.lua"
pattern = "if G.FILE_HANDLER.run then"
position = "after"
match_indent = true
overwrite = false
payload = """
   if LOADER and G.ARGS and G.ARGS.save_run then
      local save = G.ARGS.save_run

      -- If we are creating a new branch, pass the list of files to
      -- be pruned to the save manager thread via the save table.
      if LOADER.pending_future_prune and next(LOADER.pending_future_prune) then
         save.LOADER_PRUNE_LIST = LOADER.pending_future_prune
         LOADER.pending_future_prune = {}
      end

      local state = G.STATE or (save and save.STATE)

      -- One-shot skip used by timeline stepping, UI/QuickLoad restores,
      -- and vanilla "Continue" loads; skips the first post-load save
      -- only if ante/round/state matches what was loaded.
      if LOADER.consume_skip_on_save then
         LOADER.consume_skip_on_save(save)
      elseif LOADER.skip_next_backup then
         save.LOADER_SKIP_BACKUP = true
         if save and (not save._file) and LOADER._last_loaded_file then
            save._file = LOADER._last_loaded_file
         end
         LOADER.skip_next_backup = false
         LOADER._restore_active = false
         LOADER._pending_skip_reason = nil
         LOADER._last_loaded_file = nil
      end

      -- Optional filtering based on game state and the mod's
      -- configuration. These booleans live in the mod config
      -- and control whether a backup is kept at each key
      -- transition (blind select, selecting hand, end of round,
      -- shop). If a state is recognized but disabled, we mark
      -- this save to be skipped by the backup thread while
      -- still allowing the normal save.jkr to be written.
      if save.LOADER_SKIP_BACKUP ~= true then
         local cfg = LOADER.config or {}
         local st = G.STATES
         if state and st then
            local recognized = false
            local allow = false

            if state == st.BLIND_SELECT then
               recognized = true
               allow = (cfg.save_on_blind ~= false)
            elseif state == st.SELECTING_HAND then
               recognized = true
               allow = (cfg.save_on_selecting_hand ~= false)
            elseif state == st.ROUND_EVAL or state == st.HAND_PLAYED then
               recognized = true
               allow = (cfg.save_on_round_end ~= false)
            elseif state == st.SHOP then
               recognized = true
               allow = (cfg.save_on_shop ~= false)
            end

            if recognized and not allow then
               save.LOADER_SKIP_BACKUP = true
            end
         end
      end

      -- Pass the per-round retention hint through to the save manager
      -- thread so it can prune older saves for this ante/round, and
      -- emit an optional debug notification for each queued backup.
      do
         local cfg = LOADER.config or {}
         local idx = cfg.keep_antes or 7
         local map = {1, 2, 4, 6, 8, 16, 0}
         save.LOADER_KEEP_ANTES = map[idx] or 0

         local will_backup = (save.LOADER_SKIP_BACKUP ~= true)
         if cfg.debug_backups and will_backup and LOADER and LOADER.show_backup_debug then
            local game = save.GAME or {}
            local ante = (game.round_resets and tonumber(game.round_resets.ante)) or game.ante or 0
            local round = tonumber(game.round or 0) or 0
            local label = "state"
            if LOADER and LOADER.describe_state_label then
               label = LOADER.describe_state_label(state) or label
            else
               local st = G.STATES
               if st and state then
                  if state == st.BLIND_SELECT then
                     label = "blind select"
                  elseif state == st.SELECTING_HAND then
                     label = "selecting hand"
                  elseif state == st.ROUND_EVAL or state == st.HAND_PLAYED then
                     label = "end of round"
                  elseif state == st.SHOP then
                     label = "shop"
                  end
               end
            end
            LOADER.show_backup_debug(ante, round, label)
         end
      end

   end
   """